<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - PrimeDrew</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .dashboard-header { color: #212529; margin-bottom: 30px; border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        
        /* NAVIGATION BAR STYLES */
        .admin-nav {
            background-color: #343a40; /* Dark background */
            padding: 10px 20px;
            margin-bottom: 30px;
            border-radius: 5px;
            display: flex;
            gap: 20px;
        }
        .admin-nav a {
            color: #f8f9fa; /* Light text */
            text-decoration: none;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .admin-nav a:hover, .admin-nav a.active {
            background-color: #007bff; /* Highlight on hover/active */
            color: white;
        }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-left: 5px solid #007bff; }
        .stat-card h3 { margin-top: 0; font-size: 1.1rem; color: #6c757d; }
        .stat-card p { font-size: 24px; font-weight: bold; margin: 5px 0 0; }
        .table-section { margin-top: 30px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; font-size: 0.9rem; }
        th { background-color: #f8f9fa; }
        
        /* NEW/UPDATED BUTTON STYLES */
        .btn-refund { 
            background-color: #dc3545; 
            color: white; 
            border: none; 
            padding: 5px 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: background-color 0.3s; 
        }
        .btn-refund:hover { background-color: #c82333; }

        /* NEW Deposit Refund Button */
        .btn-deposit {
            background-color: #007bff; /* Primary Blue for Deposit */
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-deposit:hover { background-color: #0069d9; }
        
        .btn-approve { 
            background-color: #28a745; 
            color: white; 
            border: none; 
            padding: 5px 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: background-color 0.3s; 
        }
        .btn-approve:hover { 
            background-color: #1e7e34; 
        }
        
        .btn-block {
            background-color: #6c757d; 
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-block:hover { background-color: #5a6268; }

        .btn-activate {
            background-color: #007bff; 
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-activate:hover { background-color: #0069d9; }
        
        .alert-success { background-color: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #c3e6cb; }

        .badge-active { background-color: #28a745; color: white; padding: 4px 8px; border-radius: 3px; font-weight: bold; }
        .badge-blocked { background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 3px; font-weight: bold; }
        .badge-pending { background-color: #ffc107; color: #343a40; padding: 4px 8px; border-radius: 3px; font-weight: bold; }
        .badge-info { background-color: #17a2b8; color: white; padding: 4px 8px; border-radius: 3px; font-weight: bold; }
    </style>
</head>
<body>
    <h1 class="dashboard-header"><i class="fas fa-crown"></i> Super Admin Dashboard</h1>
    <p>Welcome, **Super Admin**. Operational summary and pending actions are listed below.</p>
    
    <div class="admin-nav">
        <a href="{{ url_for('admin_dashboard') }}" class="{{ 'active' if request.endpoint == 'admin_dashboard' else '' }}">
            <i class="fas fa-tachometer-alt"></i> Dashboard & Finance
        </a>
        <a href="{{ url_for('admin_users') }}" class="{{ 'active' if request.endpoint == 'admin_users' else '' }}">
            <i class="fas fa-users-cog"></i> User & Host Management
        </a>
        <a href="{{ url_for('admin_complaints') }}" class="{{ 'active' if request.endpoint == 'admin_complaints' else '' }}">
            <i class="fas fa-exclamation-circle"></i> Support Tickets
        </a>
        <a href="{{ url_for('logout') }}" style="margin-left: auto;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert-success">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Revenue (Confirmed)</h3>
            <p>₹{{ "{:,.0f}".format(total_revenue) }}</p>
        </div>
        <div class="stat-card" style="border-left: 5px solid #28a745;">
            <h3>Confirmed Bookings</h3>
            <p>{{ confirmed_bookings_count }}</p>
        </div>
        <div class="stat-card" style="border-left: 5px solid #dc3545;">
            <h3>Pending Cancellation Refunds</h3> 
            <p>{{ cancelled_bookings_count }}</p>
        </div>
        <div class="stat-card" style="border-left: 5px solid #ffc107;">
            <h3>Pending Deposit Refunds</h3> 
            <p>{{ deposit_refund_count }}</p>
        </div>
        <div class="stat-card" style="border-left: 5px solid #17a2b8;">
            <h3>Total Hosts</h3>
            <p>{{ total_hosts }}</p>
        </div>
    </div>
    
    <div class="table-section" style="border-left: 5px solid #007bff; margin-bottom: 50px;">
        <h2><i class="fas fa-chart-area"></i> Financial Health Overview</h2>
        <div class="stats-grid">
            <div class="stat-card" style="border-left: 5px solid #28a745;">
                <h3>Gross Revenue (Total Paid)</h3>
                <p>₹{{ "{:,.0f}".format(total_revenue) }}</p>
            </div>
            <div class="stat-card" style="border-left: 5px solid #17a2b8;">
                <h3>Platform Commission (Net Profit)</h3>
                <p>₹{{ "{:,.0f}".format(total_platform_commission) }}</p>
            </div>
            <div class="stat-card" style="border-left: 5px solid #ffc107;">
                <h3>Total Payout Due to Hosts</h3>
                <p>₹{{ "{:,.0f}".format(total_payout_due) }}</p>
            </div>
        </div>
        
        <h3><i class="fas fa-hand-holding-usd"></i> Host Earnings Summary (Top 5 Lifetime)</h3>
        {% if host_payouts_list %}
        <table style="max-width: 600px;">
            <thead>
                <tr>
                    <th>Host Name</th>
                    <th>Tier</th>
                    <th>Confirmed Bookings</th>
                    <th>Total Earnings (Payout)</th>
                </tr>
            </thead>
            <tbody>
                {% for host in host_payouts_list[:5] %}
                <tr>
                    <td>{{ host.name }}</td>
                    <td><span class="badge-info">{{ host.tier }}%</span></td>
                    <td>{{ host.total_bookings }}</td>
                    <td style="font-weight: bold; color: green;">₹{{ "{:,.0f}".format(host.total_earnings) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No confirmed bookings yet to calculate host payouts.</p>
        {% endif %}
    </div>

    <div class="table-section" style="border-left: 5px solid #ffc107;">
        <h2><i class="fas fa-wallet"></i> Pending Deposit Refunds ({{ deposit_refund_count }})</h2>
        {% if pending_deposit_refunds %}
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Customer / End Date</th>
                        <th>Vehicle</th>
                        <th>Deposit Amount</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in pending_deposit_refunds %}
                    <tr>
                        <td>#{{ booking.id }}</td>
                        <td>{{ booking.customer.first_name }} ({{ booking.end_date | split_date }})</td>
                        <td>{{ booking.vehicle_info.name }}</td>
                        <td style="color: #007bff; font-weight: bold;">₹{{ "{:,.0f}".format(booking.deposit_amount) }}</td>
                        <td><span class="badge-pending">{{ booking.deposit_refund_status }}</span></td>
                        <td>
                            <button class="btn-deposit" onclick="processDepositRefund({{ booking.id }})">
                                <i class="fas fa-check"></i> Mark Deposit Processed
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>✅ All refundable deposits are up-to-date.</p>
        {% endif %}
    </div>
    <div class="table-section">
        <h2><i class="fas fa-money-check-alt"></i> Pending Cancellation Refunds ({{ cancelled_bookings_count }})</h2>
        {% if cancelled_details %}
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Customer / Date</th>
                        <th>Vehicle</th>
                        <th>Price Paid</th>
                        <th>Refund Due</th>
                        <th>Fee</th>
                        <th>Payment ID</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detail in cancelled_details %}
                        <tr>
                            <td>#{{ detail.booking_id }}</td>
                            <td>{{ detail.customer_name }} ({{ detail.booked_at | split_date }})</td> 
                            <td>{{ detail.vehicle_name }} (Host: {{ detail.vehicle_host }})</td>
                            <td>₹{{ detail.total_price|round }}</td>
                            <td style="color: green; font-weight: bold;">₹{{ detail.refund_due|round }}</td>
                            <td style="color: red;">₹{{ detail.cancellation_fee }}</td>
                            <td>{{ detail.payment_id }}</td>
                            <td>
                                <button class="btn-refund" onclick="processRefund({{ detail.booking_id }})">
                                    Mark Processed
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>✅ All booking cancellation refunds are processed.</p>
        {% endif %}
    </div>

    <div class="table-section">
        <h2><i class="fas fa-user-check"></i> Pending Host Approvals ({{ pending_hosts|length }})</h2>
        {% if pending_hosts %}
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Contact / Email</th>
                        <th>DL Expiry</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for host in pending_hosts %}
                    <tr>
                        <td>{{ host.id }}</td>
                        <td>{{ host.first_name }} {{ host.last_name }}</td>
                        <td>{{ host.phone }} / {{ host.email }}</td>
                        <td>{{ host.dl_expiry }}</td>
                        <td>
                            <button class="btn-approve" onclick="approveHost({{ host.id }})">
                                <i class="fas fa-check"></i> Approve Host
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>✅ All hosts are approved. No pending requests.</p>
        {% endif %}
    </div>

    <div class="table-section">
        <h2><i class="fas fa-chart-line"></i> Host Booking Summary</h2>
        {% if host_booking_summary %}
        <table>
            <thead>
                <tr>
                    <th>Host Name</th>
                    <th>Confirmed Bookings</th>
                </tr>
            </thead>
            <tbody>
                {% for name, count in host_booking_summary %}
                <tr>
                    <td>{{ name }}</td>
                    <td>{{ count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No confirmed bookings yet.</p>
        {% endif %}
    </div>

    <div style="margin-top: 30px;"><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a></div>

    <script>
        function processRefund(bookingId) {
            if (!confirm(`Are you sure you want to mark cancellation refund for Booking #${bookingId} as Processed? This action assumes the payment gateway refund was successful.`)) {
                return;
            }

            fetch(`/api/admin/process_refund/${bookingId}`, {
                method: 'POST',
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                // Handle non-200 status codes gracefully
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Server returned an error.');
                });
            })
            .then(data => {
                alert(data.message);
                if (data.success) {
                    // Reload the page to remove the processed item from the table and display the flash message
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred: ' + error.message);
            });
        }
        
        // --- NEW JAVASCRIPT FUNCTION FOR DEPOSIT REFUND ---
        function processDepositRefund(bookingId) {
            // Find the deposit amount from the table row for display in the confirm box
            const row = document.querySelector(`button[onclick*="processDepositRefund(${bookingId})"]`).closest('tr');
            const depositAmountText = row ? row.querySelector('td:nth-child(4)').textContent : 'Deposit';

            if (!confirm(`Are you sure you want to mark the Refundable ${depositAmountText} for Booking #${bookingId} as PROCESSED? This confirms the vehicle was returned safely and the refund is being initiated/completed.`)) {
                return;
            }

            fetch(`/api/admin/process_deposit_refund/${bookingId}`, {
                method: 'POST',
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Server returned an error.');
                });
            })
            .then(data => {
                alert(data.message);
                if (data.success) {
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred: ' + error.message);
            });
        }
        // -------------------------------------------------
        
        function approveHost(userId) {
            if (!confirm(`Are you sure you want to approve this host (ID: ${userId})? They will immediately be able to list vehicles and an SMS notification will be sent.`)) {
                return;
            }

            fetch(`/api/admin/approve_host/${userId}`, {
                method: 'POST',
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(result => {
                alert(result.body.message);
                if (result.body.success) {
                    // Reload the page to remove the pending host from the list and show the flash message
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while communicating with the server.');
            });
        }

        // NOTE: The toggleHostStatus function is now only used in admin_user_list.html and admin_user_profile.html
    </script>
</body>
</html>