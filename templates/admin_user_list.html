<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User & Host Management - PrimeDrew</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .dashboard-header { color: #212529; margin-bottom: 30px; border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        .admin-nav {
            background-color: #343a40;
            padding: 10px 20px;
            margin-bottom: 30px;
            border-radius: 5px;
            display: flex;
            gap: 20px;
        }
        .admin-nav a {
            color: #f8f9fa;
            text-decoration: none;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .admin-nav a:hover, .admin-nav a.active {
            background-color: #007bff;
            color: white;
        }
        .table-section { margin-top: 30px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; font-size: 0.9rem; }
        th { background-color: #f8f9fa; }
        .badge-active { background-color: #28a745; color: white; padding: 4px 8px; border-radius: 3px; font-weight: bold; }
        .badge-blocked { background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 3px; font-weight: bold; }
        .badge-pending { background-color: #ffc107; color: #343a40; padding: 4px 8px; border-radius: 3px; font-weight: bold; }
        .btn-view { background-color: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-block { background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; position: relative; right: -1rem;}
        .btn-activate { background-color: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1 class="dashboard-header"><i class="fas fa-crown"></i> Super Admin Dashboard</h1>
    
    <div class="admin-nav">
        <a href="{{ url_for('admin_dashboard') }}">
            <i class="fas fa-tachometer-alt"></i> Dashboard & Finance
        </a>
        <a href="{{ url_for('admin_users') }}" class="active">
            <i class="fas fa-users-cog"></i> User & Host Management
        </a>
        <a href="{{ url_for('logout') }}" style="margin-left: auto;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert-success">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="table-section">
        <h2><i class="fas fa-user-friends"></i> All Users (Hosts & Customers) ({{ all_users|length }})</h2>
        {% if all_users %}
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Phone</th>
                        <th>Approval</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in all_users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.first_name }} {{ user.last_name }}</td>
                        <td>{{ user.role|capitalize }}</td>
                        <td>{{ user.phone }}</td>
                        <td>
                            {% if user.role == 'host' or user.role == 'both' %}
                                <span class="badge {% if user.is_approved_host %}badge-active{% else %}badge-pending{% endif %}">
                                    {% if user.is_approved_host %}Approved{% else %}Pending{% endif %}
                                </span>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_active %}
                                <span class="badge badge-active">Active</span>
                            {% else %}
                                <span class="badge badge-blocked">BLOCKED</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('view_user_profile', user_id=user.id) }}" class="btn-view">
                                <i class="fas fa-eye"></i> View Profile
                            </a>
                            
                            {% if user.role == 'host' or user.role == 'both' %}
                                <button 
                                    class="{% if user.is_active %}btn-block{% else %}btn-activate{% endif %}" 
                                    onclick="toggleHostStatus({{ user.id }}, '{{ 'true' if user.is_active else 'false' }}')"
                                >
                                    {% if user.is_active %}
                                        <i class="fas fa-ban"></i> Block
                                    {% else %}
                                        <i class="fas fa-redo"></i> Activate
                                    {% endif %}
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No users found in the system.</p>
        {% endif %}
    </div>

    <script>
        // --- NEW JAVASCRIPT FUNCTION FOR BLOCKING/ACTIVATING (COPIED FROM DASHBOARD LOGIC) ---
        function toggleHostStatus(userId, isActiveString) {
            // Convert string 'true'/'false' from Jinja to boolean
            const isActive = isActiveString === 'true'; 
            const action = isActive ? 'block' : 'activate';
            const confirmation = isActive 
                ? `Are you sure you want to BLOCK Host ID ${userId}? This will immediately make all their vehicles unavailable and log them out.`
                : `Are you sure you want to ACTIVATE Host ID ${userId}? They will regain access to their account (vehicles must be manually re-activated).`;

            if (!confirm(confirmation)) {
                return;
            }

            fetch(`/api/admin/toggle-host-status/${userId}`, {
                method: 'POST',
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(result => {
                alert(result.body.message);
                if (result.body.success) {
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while communicating with the server.');
            });
        }
        // --------------------------------------------------------
    </script>
</body>
</html>