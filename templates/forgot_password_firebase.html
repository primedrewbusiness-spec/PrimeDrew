<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Prime Drew</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='login.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

        // üî• CORRECTED CONFIGURATION üî•
        const firebaseConfig = {
            apiKey: "AIzaSyA5jmGB8WQ3kaj2mkNE4V10bqwGLr9VBTo", // Taken from registration_form.html
            authDomain: "vehicle-rent-50cc6.firebaseapp.com",
            projectId: "vehicle-rent-50cc6",
            storageBucket: "vehicle-rent-50cc6.firebasestorage.app",
            messagingSenderId: "587468145475",
            appId: "1:587468145475:web:2395afe94822328241e5f6",
            measurementId: "G-6LE6WTXCL0"
        };

        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app); 
        window.RecaptchaVerifier = RecaptchaVerifier;
        window.signInWithPhoneNumber = signInWithPhoneNumber;
    </script>
</head>
<body>
    <div class="main-wrapper">
        <div class="visual-pane">
            <div class="logo-box">
                <span class="logo-icon">üöóüí®</span>
                <h1>PrimeDrew</h1>
                <p>Your journey is our priority. Reset your password securely.</p>
            </div>
            <div class="decor-circle circle-1"></div>
            <div class="decor-circle circle-2"></div>
        </div>

        <div class="form-pane">
            <div class="login-box">
                <p class="small-link"><a href="{{ url_for('login') }}">‚Üê Back to Login</a></p>

                <h2 id="step-title">Reset Password (Step 1/2)</h2>
                <p class="subtitle" id="step-subtitle">Enter your registered **10-digit** mobile number for verification.</p>

                <div id="alert-box" class="alert-error" style="display: none; padding: 10px; margin-bottom: 15px; border-radius: 5px;"></div>

                <form id="reset-flow-form" class="login-form">
                    
                    <div id="stage1_phone">
                        <div class="form-group">
                            <label for="phone"><i class="fas fa-mobile-alt"></i> Mobile Number (10 digits)</label>
                            <input id="phone" type="tel" required placeholder="9876543210" pattern="\d{10}" maxlength="10">
                            <p class="hint">We use this number to send an OTP and match your account.</p>
                        </div>
                        
                        <div id="recaptcha-container" style="margin-top: 20px;"></div>
                        <p id="authMessage" class="hint" style="color: #5aa7ff; font-weight: 600; text-align: center;">Complete reCAPTCHA and click "Send OTP".</p>
                        
                        <button type="button" class="btn-primary" id="send-otp-btn" onclick="sendOTP()">
                            SEND OTP <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>

                    <div id="stage2_reset" style="display: none;">
                        <div class="form-group">
                            <label for="verification-code"><i class="fas fa-key"></i> OTP (Verification Code)</label>
                            <input id="verification-code" type="text" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6">
                        </div>
                        <div class="form-group">
                            <label for="new-password"><i class="fas fa-lock"></i> New Password</label>
                            <input id="new-password" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8">
                            <p class="hint">Min 8 characters.</p>
                        </div>
                        <div class="form-group">
                            <label for="confirm-password"><i class="fas fa-lock"></i> Confirm New Password</label>
                            <input id="confirm-password" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8">
                        </div>
                        
                        <button type="button" class="btn-primary" id="verify-btn" onclick="verifyAndReset()">
                            RESET PASSWORD <i class="fas fa-redo"></i>
                        </button>
                        <p class="small-link" style="text-align: center; margin-top: 15px;">
                            <a href="#" onclick="window.location.reload();">Wrong number? Start over.</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
<script>
    // Ensure global variables are set by the module import before running the script
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initializeResetFlow, 500); 
    });
    
    function initializeResetFlow() {
        if (!window.auth || !window.RecaptchaVerifier || !window.signInWithPhoneNumber) {
            console.error("Firebase dependencies not loaded. Check module imports.");
            document.getElementById('alert-box').textContent = "Initialization failed. Check console for Firebase errors.";
            document.getElementById('alert-box').style.display = 'block';
            return;
        }

        const auth = window.auth;
        const phoneInput = document.getElementById('phone');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const verifyBtn = document.getElementById('verify-btn');
        const authMessage = document.getElementById('authMessage');
        const alertBox = document.getElementById('alert-box');
        const stage1 = document.getElementById('stage1_phone');
        const stage2 = document.getElementById('stage2_reset');
        const stepTitle = document.getElementById('step-title');
        const stepSubtitle = document.getElementById('step-subtitle');

        let confirmationResult;
        let finalPhoneNumber = ''; 

        function showAlert(message, type = 'error') {
            alertBox.textContent = message;
            alertBox.className = `alert-${type === 'success' ? 'success' : 'error'}`; // Use success class if needed
            alertBox.style.display = 'block';
        }

        function hideAlert() {
            alertBox.style.display = 'none';
        }

        // Initialize reCAPTCHA
        window.recaptchaVerifier = new window.RecaptchaVerifier('recaptcha-container', {
            'size': 'normal',
            'callback': (response) => { authMessage.innerText = "reCAPTCHA solved. Click 'Send OTP'."; },
            'expired-callback': () => { showAlert("reCAPTCHA expired. Please re-run verification.", 'info'); sendOtpBtn.disabled = false; }
        }, auth);
        window.recaptchaVerifier.render().catch(error => console.error("reCAPTCHA rendering failed:", error));
    
        window.sendOTP = async function() {
            hideAlert();
            if (!phoneInput.checkValidity()) { 
                phoneInput.reportValidity(); 
                return; 
            }
            
            finalPhoneNumber = phoneInput.value.trim(); 
            // üî• E.164 Format: Prepending +91 üî•
            const phoneNumberE164 = "+91" + finalPhoneNumber; 

            authMessage.innerText = "Sending OTP...";
            sendOtpBtn.disabled = true;

            try {
                // Firebase OTP Request
                confirmationResult = await window.signInWithPhoneNumber(auth, phoneNumberE164, window.recaptchaVerifier);
                
                // Success: Move to Stage 2
                stepTitle.textContent = 'Verify OTP (Step 2/2)';
                stepSubtitle.textContent = `Enter the OTP sent to +91 ${finalPhoneNumber} and set a new password.`;
                stage1.style.display = 'none';
                stage2.style.display = 'block';
                phoneInput.readOnly = true;
                showAlert("‚úÖ OTP sent successfully. Check your mobile.", 'success');

            } catch (error) {
                console.error("Error during OTP request:", error);
                
                let errorMessage = "Failed to send OTP. Ensure your number is correct and try again.";
                if (error.code === 'auth/invalid-phone-number') {
                    errorMessage = "Invalid 10-digit number format or not a valid Indian mobile number.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many requests. Try again later."
                } else if (error.message.includes("auth/captcha-check-failed")) {
                    errorMessage = "ReCAPTCHA failed or was not completed. Please try again."
                }
                
                showAlert(errorMessage);
                sendOtpBtn.disabled = false;
                authMessage.innerText = "Error during OTP. Please try again.";

                // Reset Recaptcha on failure
                if (window.recaptchaVerifier && window.recaptchaVerifier.render) {
                    window.recaptchaVerifier.render().then(widgetId => {
                        window.recaptchaVerifier.reset(widgetId);
                    });
                }
            }
        }

        window.verifyAndReset = async function() {
            hideAlert();
            
            const code = document.getElementById('verification-code').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showAlert("New password and confirm password do not match.");
                return;
            }
            if (newPassword.length < 8) {
                showAlert("Password must be at least 8 characters long.");
                return;
            }
            
            if (!confirmationResult) {
                showAlert("Verification process failed. Please restart from Step 1.");
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.textContent = "Processing...";

            try {
                // 1. Firebase OTP Verification
                await confirmationResult.confirm(code); 
                
                // 2. If Firebase succeeds, send new password to Flask backend
                const response = await fetch('{{ url_for("reset_password_via_firebase") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: finalPhoneNumber, // 10-digit number for Flask DB lookup
                        new_password: newPassword
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert("‚úÖ Password reset successful! Redirecting to login...", 'success');
                    setTimeout(() => {
                        window.location.href = '{{ url_for("login") }}';
                    }, 2000); 
                } else {
                    // Error from Flask backend (e.g., user not found in DB)
                    showAlert("‚ùå " + result.message);
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = "RESET PASSWORD";
                }

            } catch (error) {
                console.error("Error during verification or reset:", error);
                
                let errorMessage = "Password reset failed due to an unknown error.";
                if (error.code === 'auth/invalid-verification-code') {
                    errorMessage = "‚ùå Invalid OTP. Please try again.";
                } else if (error.code === 'auth/code-expired') {
                    errorMessage = "‚ùå OTP expired. Please reload the page and try again.";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "‚ùå Network error. Check your connection or try again.";
                }
                
                showAlert(errorMessage);
                verifyBtn.disabled = false;
                verifyBtn.textContent = "RESET PASSWORD";
            }
        }
    }
</script>
</body>
</html>